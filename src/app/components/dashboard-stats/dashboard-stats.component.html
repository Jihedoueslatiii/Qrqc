<app-bar></app-bar>

<div *ngIf="loading" class="loading">Chargement des statistiques...</div>

<div id="reportContent">
  <div *ngIf="!loading && stats.length" class="dashboard-container">
    
    <!-- Alert Banner -->
    <div *ngIf="hasCriticalAlerts()" [class]="getAlertBannerClass()">
      {{ getAlertBannerMessage() }}
    </div>
    
    <!-- Action Buttons -->
    <div class="actions-row">
      <button class="btn btn-primary" (click)="generatePDF()">
        üìÑ Download KPI Report (PDF)
      </button>
      <button class="btn btn-success" (click)="exportToExcel()">
        üìä Exporter vers Excel
      </button>
    </div>

    <h2>üìä KPI Dashboard Overview</h2>
    
    <!-- Alert Summary -->
    <div *ngIf="hasCriticalAlerts()" class="alert-summary">
      <h3>üîî R√©sum√© des Alertes</h3>
      <p>Critique: {{ getAlertSummary().critical }} | Attention: {{ getAlertSummary().warning }} | Total: {{ getAlertSummary().total }}</p>
    </div>
    
    <!-- Top summary cards with alert states -->
    <div class="cards-row">
      <div class="card card-blue" [class]="getCardAlertClass(getAverage('qualite'))">
        <div class="alert-status" [class]="getAlertStatus(getAverage('qualite')).class">
          {{ getAlertStatus(getAverage('qualite')).text }}
        </div>
        <h3>{{ getMetricStatusIcon(getAverage('qualite')) }} Qualit√© Des Produits</h3>
        <p class="large-stat">{{ getAverage('qualite') | number:'1.1-1' }}%</p>
        <small>Seuil: {{ threshold }}%</small>
      </div>
      
      <div class="card card-orange" [class]="getCardAlertClass(getAverage('delai'))">
        <div class="alert-status" [class]="getAlertStatus(getAverage('delai')).class">
          {{ getAlertStatus(getAverage('delai')).text }}
        </div>
        <h3>{{ getMetricStatusIcon(getAverage('delai')) }} D√©lai Des Produits</h3>
        <p class="large-stat">{{ getAverage('delai') | number:'1.1-1' }}%</p>
        <small>Seuil: {{ threshold }}%</small>
      </div>
      
      <div class="card card-green" [class]="getCardAlertClass(getAverage('cout'))">
        <div class="alert-status" [class]="getAlertStatus(getAverage('cout')).class">
          {{ getAlertStatus(getAverage('cout')).text }}
        </div>
        <h3>{{ getMetricStatusIcon(getAverage('cout')) }} Co√ªt Des Produits</h3>
        <p class="large-stat">{{ getAverage('cout') | number:'1.1-1' }}%</p>
        <small>Seuil: {{ threshold }}%</small>
      </div>
      
      <div class="card card-teal" [class]="getCardAlertClass(avgEfficacite)">
        <div class="alert-status" [class]="getAlertStatus(avgEfficacite).class">
          {{ getAlertStatus(avgEfficacite).text }}
        </div>
        <h3>{{ getMetricStatusIcon(avgEfficacite) }} Efficacit√© (D√©lai)</h3>
        <p class="large-stat">{{ avgEfficacite | number:'1.1-1' }}%</p>
        <small>Seuil: {{ threshold }}%</small>
      </div>
      
      <div class="card card-cyan">
        <h3>üìà KPI IP Totals</h3>
        <p><strong>Total:</strong> {{ totalKpiIp }}</p>
        <p><strong>HSE Tag:</strong> {{ totalHseTag }}</p>
        <p><strong>IP:</strong> {{ totalIp }}</p>
      </div>
    </div>

    <!-- Project cards row with alert states -->
    <div class="projects-cards-row">
      <div 
        class="project-card" 
        [class]="getProjectCardAlertClass(stat)"
        *ngFor="let stat of stats"
      >
        <div class="alert-status" [class]="getAlertStatus(stat.totalAverage).class">
          {{ getAlertStatus(stat.totalAverage).text }}
        </div>
        
        <h4>{{ stat.project }}</h4>
        
        <div class="project-stat">
          <span class="label">{{ getMetricStatusIcon(stat.qualite) }} Qualit√©:</span>
          <span [style.color]="progressBarColor(stat.qualite)" class="value">
            {{ stat.qualite?.toFixed(1) ?? 'N/A' }}%
          </span>
        </div>
        
        <div class="project-stat">
          <span class="label">{{ getMetricStatusIcon(stat.delai) }} D√©lai:</span>
          <span [style.color]="progressBarColor(stat.delai)" class="value">
            {{ stat.delai?.toFixed(1) ?? 'N/A' }}%
          </span>
        </div>
        
        <div class="project-stat">
          <span class="label">{{ getMetricStatusIcon(stat.cout) }} Co√ªt:</span>
          <span [style.color]="progressBarColor(stat.cout)" class="value">
            {{ stat.cout?.toFixed(1) ?? 'N/A' }}%
          </span>
        </div>
        
        <!-- Alert indicators -->
        <div class="alert-indicators">
          <small>
            üî¥ Critique: {{ getCriticalMetricsCount(stat) }} | 
            üü° Attention: {{ getWarningMetricsCount(stat) }}
          </small>
        </div>
      </div>
    </div>

    <!-- Detailed table with alert highlights -->
    <div class="table-wrapper">
      <table class="stats-table">
        <thead>
          <tr>
            <th>Project</th>
            <th>Qualit√© Avg (%)</th>
            <th>Qualit√© Count</th>
            <th>Qualit√© Min (%)</th>
            <th>Qualit√© Max (%)</th>
            <th>D√©lai Avg (%)</th>
            <th>D√©lai Count</th>
            <th>D√©lai Min (%)</th>
            <th>D√©lai Max (%)</th>
            <th>Co√ªt Avg (%)</th>
            <th>Co√ªt Count</th>
            <th>Co√ªt Min (%)</th>
            <th>Co√ªt Max (%)</th>
            <th>Total Average (%)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let stat of stats">
            <td><strong>{{ stat.project }}</strong></td>
            
            <td [class]="getTableCellAlertClass(stat.qualite)" 
                [style.background-color]="progressBarColor(stat.qualite)">
              {{ stat.qualite?.toFixed(1) ?? 'N/A' }}
            </td>
            <td>{{ stat.qualiteCount }}</td>
            <td>{{ stat.qualiteMin?.toFixed(1) ?? 'N/A' }}</td>
            <td>{{ stat.qualiteMax?.toFixed(1) ?? 'N/A' }}</td>
            
            <td [class]="getTableCellAlertClass(stat.delai)" 
                [style.background-color]="progressBarColor(stat.delai)">
              {{ stat.delai?.toFixed(1) ?? 'N/A' }}
            </td>
            <td>{{ stat.delaiCount }}</td>
            <td>{{ stat.delaiMin?.toFixed(1) ?? 'N/A' }}</td>
            <td>{{ stat.delaiMax?.toFixed(1) ?? 'N/A' }}</td>
            
            <td [class]="getTableCellAlertClass(stat.cout)" 
                [style.background-color]="progressBarColor(stat.cout)">
              {{ stat.cout?.toFixed(1) ?? 'N/A' }}
            </td>
            <td>{{ stat.coutCount }}</td>
            <td>{{ stat.coutMin?.toFixed(1) ?? 'N/A' }}</td>
            <td>{{ stat.coutMax?.toFixed(1) ?? 'N/A' }}</td>
            
            <td [class]="getTableCellAlertClass(stat.totalAverage)" 
                [style.background-color]="progressBarColor(stat.totalAverage)">
              {{ stat.totalAverage?.toFixed(1) ?? 'N/A' }}
            </td>
            
            <td>
              <span class="alert-status" [class]="getAlertStatus(stat.totalAverage).class">
                {{ getAlertStatus(stat.totalAverage).text }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div *ngIf="!loading && !stats.length" class="loading">
  ‚ö†Ô∏è Aucune donn√©e statistique disponible.
</div>

<!-- Alert message display -->
<div *ngIf="alertMessage" class="alert-message">
  {{ alertMessage }}
</div>