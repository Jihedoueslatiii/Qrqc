<app-bar></app-bar>

<div class="container">
  <h1 class="delai-kpi-title"> Analyse Cause & Plan d'action</h1>

  <!-- Loading Message -->
  <div *ngIf="loading" class="loading-container">
    ⏳ Chargement des données...
  </div>

  <!-- Add Button -->
  <div class="action-bar">
    <button mat-raised-button color="primary" (click)="openAddModal()">
      <mat-icon>add</mat-icon> Ajouter une analyse
    </button>
  </div>

  <!-- Add Modal Backdrop -->
  <div class="modal-backdrop" *ngIf="showAddModal" (click)="closeAddModal()"></div>

  <!-- Add Modal -->
  <div class="modal" *ngIf="showAddModal">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Ajouter une nouvelle analyse</h3>
      <form (ngSubmit)="addAnalyse()" #addAnalyseForm="ngForm">
        <div class="form-row">
          <label for="date">Date :</label>
          <input
            type="date"
            id="date"
            name="date"
            [(ngModel)]="newAnalyse.date"
            required
          />
        </div>

        <div class="form-row">
          <label for="semaine">Semaine :</label>
          <input
            type="number"
            id="semaine"
            name="semaine"
            [(ngModel)]="newAnalyse.semaine"
            min="0"
            required
          />
        </div>

        <div class="form-row">
          <label for="indicateur">Indicateur :</label>
          <input
            type="text"
            id="indicateur"
            name="indicateur"
            [(ngModel)]="newAnalyse.indicateur"
            required
          />
        </div>

        <div class="form-row">
          <label for="probleme">Problème :</label>
          <input
            type="text"
            id="probleme"
            name="probleme"
            [(ngModel)]="newAnalyse.probleme"
            required
          />
        </div>

        <div class="form-row">
          <label for="pourquoi">Pourquoi :</label>
          <input
            type="text"
            id="pourquoi"
            name="pourquoi"
            [(ngModel)]="newAnalyse.pourquoi"
            required
          />
        </div>

        <h4>Plan d'Action</h4>

        <div class="form-row">
          <label for="action">Action :</label>
          <input
            type="text"
            id="action"
            name="action"
            [(ngModel)]="newAnalyse.planAction.action"
            required
          />
        </div>

        <div class="form-row">
          <label for="pilote">Pilote :</label>
          <input
            type="text"
            id="pilote"
            name="pilote"
            [(ngModel)]="newAnalyse.planAction.pilote"
          />
        </div>

        <div class="form-row">
          <label for="delai">Délai :</label>
          <input
            type="date"
            id="delai"
            name="delai"
            [(ngModel)]="newAnalyse.planAction.delai"
            required
          />
        </div>

        <div class="form-row">
          <label for="statut">Statut :</label>
          <select
            id="statut"
            name="statut"
            [(ngModel)]="newAnalyse.planAction.statut"
            required
          >
            <option value="NOT_STARTED">Not Started</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="COMPLETED">Completed</option>
          </select>
        </div>

        <div style="margin-top: 15px; text-align: right;">
          <button
            type="button"
            class="btn-cancel"
            (click)="closeAddModal()"
            style="margin-right: 10px;"
          >
            Annuler
          </button>
          <button
            type="submit"
            [disabled]="addAnalyseForm.invalid"
            class="btn-submit"
          >
            Ajouter
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Table -->
  <div class="table-container" *ngIf="!loading && analyseCauses.length">
      <div class="table-scroll-wrapper">

    <table mat-table [dataSource]="analyseCauses" class="mat-elevation-z2">
      <!-- Date Column -->
      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef>Date</th>
        <td mat-cell *matCellDef="let analyse; let i = index" [formGroup]="getFormGroup(i)">
          <input
            *ngIf="editingRowIndex === i"
            matInput
            type="date"
            formControlName="date"
          />
          <span *ngIf="editingRowIndex !== i">{{ analyse.date | date: 'dd/MM/yyyy' }}</span>
        </td>
      </ng-container>

      <!-- Semaine Column -->
      <ng-container matColumnDef="semaine">
        <th mat-header-cell *matHeaderCellDef>Semaine</th>
        <td mat-cell *matCellDef="let analyse; let i = index" [formGroup]="getFormGroup(i)">
          <input
            *ngIf="editingRowIndex === i"
            matInput
            type="number"
            formControlName="semaine"
            min="0"
          />
          <span *ngIf="editingRowIndex !== i">{{ analyse.semaine }}</span>
        </td>
      </ng-container>

      <!-- Indicateur Column -->
      <ng-container matColumnDef="indicateur">
        <th mat-header-cell *matHeaderCellDef>Indicateur</th>
        <td mat-cell *matCellDef="let analyse; let i = index" [formGroup]="getFormGroup(i)">
          <input
            *ngIf="editingRowIndex === i"
            matInput
            type="text"
            formControlName="indicateur"
          />
          <span *ngIf="editingRowIndex !== i" class="indicateur">{{ analyse.indicateur }}</span>
        </td>
      </ng-container>

      <!-- Probleme Column -->
      <ng-container matColumnDef="probleme">
        <th mat-header-cell *matHeaderCellDef>Problème</th>
        <td mat-cell *matCellDef="let analyse; let i = index" [formGroup]="getFormGroup(i)">
          <input
            *ngIf="editingRowIndex === i"
            matInput
            type="text"
            formControlName="probleme"
          />
          <span *ngIf="editingRowIndex !== i">{{ analyse.probleme }}</span>
        </td>
      </ng-container>

      <!-- Pourquoi Column -->
      <ng-container matColumnDef="pourquoi">
        <th mat-header-cell *matHeaderCellDef>Pourquoi</th>
        <td mat-cell *matCellDef="let analyse; let i = index" [formGroup]="getFormGroup(i)">
          <input
            *ngIf="editingRowIndex === i"
            matInput
            type="text"
            formControlName="pourquoi"
          />
          <span *ngIf="editingRowIndex !== i">{{ analyse.pourquoi }}</span>
        </td>
      </ng-container>

      <!-- Plan Action Columns -->
      <ng-container matColumnDef="action">
        <th mat-header-cell *matHeaderCellDef>Action</th>
        <td mat-cell *matCellDef="let analyse; let i = index" [formGroup]="getFormGroup(i)">
          <input
            *ngIf="editingRowIndex === i"
            matInput
            type="text"
            formControlName="action"
          />
          <span *ngIf="editingRowIndex !== i">{{ analyse.planAction?.action || 'Non défini' }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="pilote">
        <th mat-header-cell *matHeaderCellDef>Pilote</th>
        <td mat-cell *matCellDef="let analyse; let i = index" [formGroup]="getFormGroup(i)">
          <input
            *ngIf="editingRowIndex === i"
            matInput
            type="text"
            formControlName="pilote"
          />
          <span *ngIf="editingRowIndex !== i">{{ analyse.planAction?.pilote || 'Non défini' }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="delai">
        <th mat-header-cell *matHeaderCellDef>Délai</th>
        <td mat-cell *matCellDef="let analyse; let i = index" [formGroup]="getFormGroup(i)">
          <input
            *ngIf="editingRowIndex === i"
            matInput
            type="date"
            formControlName="delai"
          />
          <span *ngIf="editingRowIndex !== i">{{ analyse.planAction?.delai | date: 'dd/MM/yyyy' }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="statut">
        <th mat-header-cell *matHeaderCellDef>Statut</th>
        <td mat-cell *matCellDef="let analyse; let i = index" [formGroup]="getFormGroup(i)">
          <mat-select *ngIf="editingRowIndex === i" formControlName="statut">
            <mat-option value="NOT_STARTED">Not Started</mat-option>
            <mat-option value="IN_PROGRESS">In Progress</mat-option>
            <mat-option value="COMPLETED">Completed</mat-option>
          </mat-select>
          <span
            *ngIf="editingRowIndex !== i"
            [ngClass]="{
              'status-en-cours': analyse.planAction?.statut === 'NOT_STARTED',
              'status-termine': analyse.planAction?.statut === 'IN_PROGRESS',
              'status-en-retard': analyse.planAction?.statut === 'COMPLETED'
            }"
            class="status-badge"
          >
            {{ analyse.planAction?.statut || 'Non défini' }}
          </span>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let analyse; let i = index">
          <button
            mat-icon-button
            color="primary"
            *ngIf="editingRowIndex !== i"
            (click)="startEditing(i, analyse)"
          >
            <mat-icon>edit</mat-icon>
          </button>
          <button
            mat-icon-button
            color="primary"
            *ngIf="editingRowIndex === i"
            (click)="saveRow(i)"
          >
            <mat-icon>save</mat-icon>
          </button>
          <button
            mat-icon-button
            color="warn"
            *ngIf="editingRowIndex === i"
            (click)="cancelEditing()"
          >
            <mat-icon>cancel</mat-icon>
          </button>
          <button
            mat-icon-button
            color="warn"
            (click)="deleteAnalyse(analyse.id!)"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" [@slideIn]></tr>
    </table>
      </div>

  </div>

  <!-- No Data Case -->
  <div *ngIf="!loading && !analyseCauses.length" class="no-data">
    <p>😕 Aucune donnée disponible.</p>
  </div>
</div>