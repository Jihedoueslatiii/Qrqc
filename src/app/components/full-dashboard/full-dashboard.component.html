<app-bar></app-bar>

<div class="dashboard-container" style="display: flex; justify-content: center; padding: 2rem;">
  <div class="dashboard-content-wrapper" style="max-width: 900px; width: 100%;">

    <div *ngIf="loading" class="loading-state" style="text-align: center;">
      <div class="loading-spinner"></div>
      <p class="loading-text">‚è≥ Chargement des donn√©es...</p>
    </div>

    <div *ngIf="error" class="error-state" style="text-align: center;">
      <div class="error-icon">‚ö†Ô∏è</div>
      <p class="error-message">{{ error }}</p>
      <button class="retry-btn" (click)="loadData()">R√©essayer</button>
    </div>

    <div *ngIf="!loading && !error" class="dashboard-content">

      <header class="dashboard-header" style="text-align: center; margin-bottom: 1.5rem;">
        <h1 class="dashboard-title">üìä Tableau de Bord Qualit√©, Co√ªt et D√©lai</h1>
        <p class="dashboard-subtitle">Visualisation des KPIs par programme</p>
      </header>

 <div class="filter-container" style="display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
  
  <!-- Existing KPI filter -->
  <div class="filter-group" *ngIf="selectedCategory" style="min-width: 200px;">
    <label for="kpi-select">Programme</label>
    <select id="kpi-select" [(ngModel)]="selectedKPI" (change)="applyFilters()" style="width: 100%; padding: 0.3rem;">
      <option value="">-- Tous les KPIs --</option>
      <option *ngFor="let kpi of filteredKPIs" [value]="kpi">{{ kpi }}</option>
    </select>
  </div>

  <!-- Existing Pilote filter -->
  <div class="filter-group" *ngIf="selectedCategory" style="min-width: 200px;">
    <label for="pilote-select">Pilote</label>
    <select id="pilote-select" [(ngModel)]="selectedPilote" (change)="applyFilters()" style="width: 100%; padding: 0.3rem;">
      <option value="">-- Tous les pilotes --</option>
      <option *ngFor="let pilote of uniquePilotes" [value]="pilote">{{ pilote }}</option>
    </select>
  </div>

  <!-- New Date filters -->
  <div class="filter-group" style="min-width: 200px;">
    <label for="start-date">Date d√©but</label>
    <input id="start-date" type="date" [(ngModel)]="filterStartDate" (change)="applyFilters()" style="width: 100%; padding: 0.3rem;" />
  </div>

  <div class="filter-group" style="min-width: 200px;">
    <label for="end-date">Date fin</label>
    <input id="end-date" type="date" [(ngModel)]="filterEndDate" (change)="applyFilters()" style="width: 100%; padding: 0.3rem;" />
  </div>
<div class="filter-actions" style="display: flex; gap: 1rem; align-items: flex-end;">


  <button (click)="resetAllFilters()" type="button" class="btn-reset" style="padding: 0.4rem 0.8rem; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
    Restaurer Tout
  </button>

</div>

</div>


      <!-- Show all 3 categories when "all" selected -->
      <section *ngIf="selectedCategory === 'all'" class="kpi-section all-categories">
        <div *ngFor="let cat of categories" class="category-section">
          <div class="section-header" style="text-align: center;">
            <h2 class="section-title">
              <span class="section-icon">{{ getSectionIconFor(cat) }}</span>
              {{ cat | titlecase }}
              <span *ngIf="selectedKPI">- KPI: {{ selectedKPI }}</span>
            </h2>
          </div>
          <div class="chart-grid two-column" style="display: flex; justify-content: center;">
            <div class="chart-card" style="max-width: 600px; width: 100%; margin: 0 auto;">
              <h3 class="chart-title" style="text-align: center;">Tendances (Ligne)</h3>
              <div class="chart-wrapper" style="position: relative; height: 350px;">
                <canvas baseChart
                  [data]="getLineChartDataByCategory(cat)"
                  [options]="commonChartOptions"
                  chartType="line">
                </canvas>
              </div>
            </div>
          </div>
        </div>
      </section>

<section class="kpi-by-programme-section" *ngIf="filteredKPIs.length > 0 && !selectedKPI && !selectedPilote">
  <h2 style="text-align: center; margin-bottom: 1rem;">üìã Analyse par Programme</h2>

  <div *ngFor="let kpi of filteredKPIs" class="programme-group" style="margin-bottom: 3rem;">
    <h3 style="text-align: center; margin-bottom: 1rem;">Programme: {{ kpi }}</h3>
    
   <div class="charts-row" 
     style="display: flex; justify-content: space-between; gap: 2rem; flex-wrap: nowrap; max-width: 1300px; margin: 0 auto; margin-left: -80px;">

      <div class="chart-card" 
           style="flex: 1 1 0; max-width: 420px; background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); height: 370px; display: flex; flex-direction: column;">
        <h4 style="text-align: center;">Qualit√© - {{ kpi }}</h4>
        <div style="flex-grow: 1; position: relative;">
          <canvas baseChart
                  [data]="prepareBarChart(filteredQualites, kpi, 'Qualit√©')"
                  [options]="commonChartOptions"
                  chartType="bar">
          </canvas>
        </div>
      </div>

      <div class="chart-card" 
           style="flex: 1 1 0; max-width: 420px; background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); height: 370px; display: flex; flex-direction: column;">
        <h4 style="text-align: center;">Co√ªt - {{ kpi }}</h4>
        <div style="flex-grow: 1; position: relative;">
          <canvas baseChart
                  [data]="prepareBarChart(filteredCouts, kpi, 'Co√ªt')"
                  [options]="commonChartOptions"
                  chartType="bar">
          </canvas>
        </div>
      </div>

      <div class="chart-card" 
           style="flex: 1 1 0; max-width: 420px; background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); height: 370px; display: flex; flex-direction: column;">
        <h4 style="text-align: center;">D√©lai - {{ kpi }}</h4>
        <div style="flex-grow: 1; position: relative;">
          <canvas baseChart
                  [data]="prepareBarChart(filteredDelais, kpi, 'D√©lai')"
                  [options]="commonChartOptions"
                  chartType="bar">
          </canvas>
        </div>
      </div>

    </div>
  </div>
</section>



      <!-- Combined big bar chart for all KPIs in selected category, no KPI or pilote filter -->
      <section *ngIf="selectedCategory !== 'all' && selectedCategory && !selectedKPI && !selectedPilote" class="combined-kpi-chart" style="margin-bottom: 2rem;">
        <div class="section-header" style="text-align: center; margin-bottom: 1rem;">
          <h2>
            <span class="section-icon">{{ getSectionIcon() }}</span> 
            {{ selectedCategory | titlecase }} - Tous les KPIs
          </h2>
        </div>
        <div class="chart-card" style="max-width: 700px; margin: 0 auto; background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
          <h3 style="text-align: center; margin-bottom: 1rem;">R√©sultats Moyens par KPI (Histogramme)</h3>
          <div style="position: relative; height: 400px;">
            <canvas baseChart
              [data]="getBarChartDataByCategory(selectedCategory)"
              [options]="commonChartOptions"
              chartType="bar">
            </canvas>
          </div>
        </div>
      </section>

      <!-- Show single category if selectedCategory !== 'all' -->
      <section *ngIf="selectedCategory !== 'all' && selectedCategory" class="kpi-section">
        <div class="section-header" style="text-align: center;">
          <h2 class="section-title">
            <span class="section-icon">{{ getSectionIcon() }}</span> {{ selectedCategory | titlecase }}
            <span *ngIf="selectedKPI">- KPI: {{ selectedKPI }}</span>
          </h2>
        </div>

        <div class="chart-grid two-column" style="display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap;">
          <div class="chart-card" style="max-width: 450px; width: 100%; background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);">
            <h3 class="chart-title" style="text-align: center;">R√©sultats vs Objectif (Histogramme)</h3>
            <div class="chart-wrapper" style="position: relative; height: 350px;">
              <canvas baseChart
                [data]="barChartData"
                [options]="commonChartOptions"
                chartType="bar">
              </canvas>
            </div>
          </div>

          <div class="chart-card" style="max-width: 450px; width: 100%; background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);">
            <h3 class="chart-title" style="text-align: center;">Tendances (Ligne)</h3>
            <div class="chart-wrapper" style="position: relative; height: 350px;">
              <canvas baseChart
                [data]="lineChartData"
                [options]="commonChartOptions"
                chartType="line">
              </canvas>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>
