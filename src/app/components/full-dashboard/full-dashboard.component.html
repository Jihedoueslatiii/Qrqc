<app-bar></app-bar>

<div class="dashboard-container">
  <div class="dashboard-content-wrapper">

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-state">
      <div class="loading-spinner"></div>
      <p class="loading-text">‚è≥ Chargement des donn√©es...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="error-state">
      <div class="error-icon">‚ö†Ô∏è</div>
      <p class="error-message">{{ error }}</p>
      <button class="retry-btn" (click)="loadData()">R√©essayer</button>
    </div>

    <!-- Main Dashboard Content -->
    <div *ngIf="!loading && !error" class="dashboard-content">

      <!-- Dashboard Header -->
      <header class="dashboard-header">
        <h1 class="dashboard-title">üìä Tableau de Bord Qualit√©, Co√ªt et D√©lai</h1>
        <p class="dashboard-subtitle">Visualisation des KPIs par programme</p>
      </header>

      <!-- Filter Section -->
      <div class="filter-container">
        
        <!-- Programme Filter -->
        <div class="filter-group" *ngIf="selectedCategory">
          <label for="kpi-select">Programme</label>
          <select id="kpi-select" [(ngModel)]="selectedKPI" (change)="applyFilters()">
            <option value="">-- Tous les KPIs --</option>
            <option *ngFor="let kpi of filteredKPIs" [value]="kpi">{{ kpi }}</option>
          </select>
        </div>

        <!-- Pilote Filter -->
        <div class="filter-group" *ngIf="selectedCategory">
          <label for="pilote-select">Pilote</label>
          <select id="pilote-select" [(ngModel)]="selectedPilote" (change)="applyFilters()">
            <option value="">-- Tous les pilotes --</option>
            <option *ngFor="let pilote of uniquePilotes" [value]="pilote">{{ pilote }}</option>
          </select>
        </div>

        <!-- Date Filters -->
        <div class="filter-group">
          <label for="start-date">Date d√©but</label>
          <input id="start-date" type="date" [(ngModel)]="filterStartDate" (change)="applyFilters()" />
        </div>

        <div class="filter-group">
          <label for="end-date">Date fin</label>
          <input id="end-date" type="date" [(ngModel)]="filterEndDate" (change)="applyFilters()" />
        </div>

        <!-- Filter Actions -->
        <div class="filter-actions">
          <button (click)="resetAllFilters()" type="button" class="btn-reset">
            üîÑ Restaurer Tout
          </button>
        </div>

      </div>

      <!-- All Categories View -->
      <section *ngIf="selectedCategory === 'all'" class="kpi-section all-categories">
        <div *ngFor="let cat of categories" class="category-section">
          <div class="section-header">
            <h2 class="section-title">
              <span class="section-icon">{{ getSectionIconFor(cat) }}</span>
              {{ cat | titlecase }}
              <span *ngIf="selectedKPI" class="kpi-badge">- KPI: {{ selectedKPI }}</span>
            </h2>
          </div>
          <div class="chart-grid">
            <div class="chart-card full-width">
              <h3 class="chart-title">üìà Tendances Temporelles</h3>
              <div class="chart-wrapper">
                <canvas baseChart
                  [data]="getLineChartDataByCategory(cat)"
                  [options]="commonChartOptions"
                  chartType="line">
                </canvas>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Programme Analysis Section -->
      <section class="kpi-by-programme-section" *ngIf="filteredKPIs.length > 0 && !selectedKPI && !selectedPilote">
        <div class="section-header">
          <h2 class="section-title">
            <span class="section-icon">üìã</span>
            Analyse par Programme
          </h2>
        </div>

        <div *ngFor="let kpi of filteredKPIs" class="programme-group">
          <h3>üéØ Programme: {{ kpi }}</h3>
          
          <div class="charts-row">
            <!-- Quality Chart -->
            <div class="chart-card">
              <h4>‚úÖ Qualit√© - {{ kpi }}</h4>
              <div class="chart-wrapper">
                <canvas baseChart
                        [data]="prepareBarChart(filteredQualites, kpi, 'Qualit√©')"
                        [options]="commonChartOptions"
                        chartType="bar">
                </canvas>
              </div>
            </div>

            <!-- Cost Chart -->
            <div class="chart-card">
              <h4>üí∞ Co√ªt - {{ kpi }}</h4>
              <div class="chart-wrapper">
                <canvas baseChart
                        [data]="prepareBarChart(filteredCouts, kpi, 'Co√ªt')"
                        [options]="commonChartOptions"
                        chartType="bar">
                </canvas>
              </div>
            </div>

            <!-- Delay Chart -->
            <div class="chart-card">
              <h4>‚è∞ D√©lai - {{ kpi }}</h4>
              <div class="chart-wrapper">
                <canvas baseChart
                        [data]="prepareBarChart(filteredDelais, kpi, 'D√©lai')"
                        [options]="commonChartOptions"
                        chartType="bar">
                </canvas>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Combined KPI Chart -->
      <section *ngIf="selectedCategory !== 'all' && selectedCategory && !selectedKPI && !selectedPilote" 
               class="combined-kpi-chart">
        <div class="section-header">
          <h2 class="section-title">
            <span class="section-icon">{{ getSectionIcon() }}</span> 
            {{ selectedCategory | titlecase }} - Vue d'ensemble
          </h2>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">üìä R√©sultats Moyens par KPI</h3>
          <div class="chart-wrapper">
            <canvas baseChart
              [data]="getBarChartDataByCategory(selectedCategory)"
              [options]="commonChartOptions"
              chartType="bar">
            </canvas>
          </div>
        </div>
      </section>

      <!-- Single Category View -->
      <section *ngIf="selectedCategory !== 'all' && selectedCategory" class="kpi-section">
        <div class="section-header">
          <h2 class="section-title">
            <span class="section-icon">{{ getSectionIcon() }}</span> 
            {{ selectedCategory | titlecase }}
            <span *ngIf="selectedKPI" class="kpi-badge">- KPI: {{ selectedKPI }}</span>
          </h2>
        </div>

        <div class="chart-grid two-column">
          <!-- Bar Chart -->
          <div class="chart-card">
            <h3 class="chart-title">üìä R√©sultats vs Objectif</h3>
            <div class="chart-wrapper">
              <canvas baseChart
                [data]="barChartData"
                [options]="commonChartOptions"
                chartType="bar">
              </canvas>
            </div>
          </div>

          <!-- Line Chart -->
          <div class="chart-card">
            <h3 class="chart-title">üìà √âvolution Temporelle</h3>
            <div class="chart-wrapper">
              <canvas baseChart
                [data]="lineChartData"
                [options]="commonChartOptions"
                chartType="line">
              </canvas>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>